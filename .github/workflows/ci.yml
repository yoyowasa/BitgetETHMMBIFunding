name: ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_real_logs:
        description: "Run real-log validation job"
        required: false
        default: "false"
  schedule:
    - cron: "0 3 * * *"

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      - name: Syntax check
        run: python -m compileall -q .
      - name: Run tests
        run: python -m pytest -q
      - name: Validate logs (strict)
        run: make validate-logs-strict LOG_DIR=tests/fixtures/logs ARTIFACT_DIR=artifacts
      - name: Upload validate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validate-logs-report
          path: artifacts/validate_report.json
  validate_logs_runtime:
    if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_real_logs == 'true'))
    needs: checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REAL_LOG_CMD: ${{ vars.REAL_LOG_CMD }}
      REAL_LOG_DIR: ${{ vars.REAL_LOG_DIR }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run backtest or dry-run (optional)
        id: real_logs
        timeout-minutes: 20
        run: |
          if [ -z "${REAL_LOG_CMD}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "REAL_LOG_CMD is empty; skipping real-log validation."
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"
          bash scripts/run_real_logs.sh  # REAL_LOG_CMD を安全ラッパー経由で実行し、実行ログ/メタをLOG_DIR配下に残す
      - name: Validate logs (strict)
        if: steps.real_logs.outputs.skip != 'true'
        run: |
          LOG_DIR="${REAL_LOG_DIR:-logs}"
          make validate-logs-strict LOG_DIR="${LOG_DIR}" ARTIFACT_DIR=artifacts
      - name: Upload validate report
        if: always() && steps.real_logs.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validate-logs-report-real
          path: artifacts/validate_report.json
